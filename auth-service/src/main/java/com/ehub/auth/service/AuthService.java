package com.ehub.auth.service;

import com.ehub.auth.dto.*;
import com.ehub.auth.entity.User;
import com.ehub.auth.repository.UserRepository;
import com.ehub.auth.security.JwtService;
import lombok.RequiredArgsConstructor;
import org.springframework.security.authentication.AuthenticationManager;
import org.springframework.security.authentication.UsernamePasswordAuthenticationToken;
import org.springframework.security.core.userdetails.UserDetails;
import org.springframework.security.core.userdetails.UserDetailsService;
import com.ehub.auth.client.CommonClient;
import com.ehub.auth.client.NotificationClient;
import com.ehub.auth.util.UserRole;
import com.ehub.auth.util.MessageKeys;
import org.springframework.security.crypto.password.PasswordEncoder;
import org.springframework.stereotype.Service;
import org.springframework.beans.factory.annotation.Value;

import java.util.ArrayList;
import java.util.Map;

@Service
@RequiredArgsConstructor
public class AuthService {
    private final UserRepository repository;
    private final PasswordEncoder passwordEncoder;
    private final JwtService jwtService;
    private final AuthenticationManager authenticationManager;
    private final UserDetailsService userDetailsService;
    private final NotificationClient notificationClient;
    private final CommonClient commonClient;

    public void requestRegistrationOtp(String email) {
        if (repository.existsByEmail(email)) {
            throw new RuntimeException(MessageKeys.USER_ALREADY_EXISTS.getMessage());
        }
        notificationClient.sendOtp(email);
    }

    public AuthenticationResponse register(RegisterRequest request) {
        // 1. Validate OTP
        if (!notificationClient.validateOtp(request.getEmail(), request.getOtp())) {
            throw new RuntimeException(MessageKeys.INVALID_OTP.getMessage());
        }

        if (repository.existsByUsername(request.getUsername()) || repository.existsByEmail(request.getEmail())) {
            throw new RuntimeException(MessageKeys.USER_ALREADY_EXISTS.getMessage());
        }

        // 2. Get UUID from Common Service
        String uuid = commonClient.getUuid();

        var user = User.builder()
                .id(uuid)
                .username(request.getUsername())
                .email(request.getEmail())
                .password(passwordEncoder.encode(request.getPassword()))
                .enabled(true)
                .role(UserRole.PARTICIPANT)
                .build();
        repository.save(user);
        UserDetails userDetails = new org.springframework.security.core.userdetails.User(user.getUsername(), user.getPassword(), new ArrayList<>());
        var jwtToken = jwtService.generateToken(userDetails);
        return AuthenticationResponse.builder()
                .token(jwtToken)
                .build();
    }

    public AuthenticationResponse login(LoginRequest request) {
        authenticationManager.authenticate(
                new UsernamePasswordAuthenticationToken(
                        request.getUsername(),
                        request.getPassword()
                )
        );
        var user = repository.findByUsernameOrEmail(request.getUsername(), request.getUsername())
                .orElseThrow();
        UserDetails userDetails = new org.springframework.security.core.userdetails.User(user.getUsername(), user.getPassword(), new ArrayList<>());
        var jwtToken = jwtService.generateToken(userDetails);
        return AuthenticationResponse.builder()
                .token(jwtToken)
                .build();
    }

    public void resetPassword(PasswordResetRequest request) {
        // 1. Validate OTP
        if (!notificationClient.validateOtp(request.getEmail(), request.getOtp())) {
            throw new RuntimeException(MessageKeys.INVALID_OTP.getMessage());
        }

        // 2. Update Password
        var user = repository.findByEmail(request.getEmail())
                .orElseThrow(() -> new RuntimeException(MessageKeys.USER_NOT_FOUND.getMessage()));
        user.setPassword(passwordEncoder.encode(request.getNewPassword()));
        repository.save(user);
    }

    public void requestRoleUpgradeOtp(String email) {
        var user = repository.findByEmail(email)
                .orElseThrow(() -> new RuntimeException(MessageKeys.USER_NOT_FOUND.getMessage()));
        
        if (UserRole.ORGANIZER.equals(user.getRole())) {
            throw new RuntimeException(MessageKeys.ROLE_ALREADY_ORGANIZER.getMessage());
        }

        notificationClient.sendOtp(email);
    }

    public void upgradeToOrganizer(RoleUpgradeRequest request) {
        // 1. Validate OTP
        if (!notificationClient.validateOtp(request.getEmail(), request.getOtp())) {
            throw new RuntimeException(MessageKeys.INVALID_OTP.getMessage());
        }

        // 2. Update Role
        var user = repository.findByEmail(request.getEmail())
                .orElseThrow(() -> new RuntimeException(MessageKeys.USER_NOT_FOUND.getMessage()));
        
        user.setRole(UserRole.ORGANIZER);
        repository.save(user);
    }

    private void validateOtp(String email, String otp) {
        if (!notificationClient.validateOtp(email, otp)) {
            throw new RuntimeException(MessageKeys.INVALID_OTP.getMessage());
        }
    }

    public User getProfile(String username) {
        return repository.findByUsername(username)
                .orElseThrow(() -> new RuntimeException(MessageKeys.USER_NOT_FOUND.getMessage()));
    }

    public boolean validateToken(String token) {
        try {
            String username = jwtService.extractUsername(token);
            UserDetails userDetails = userDetailsService.loadUserByUsername(username);
            return jwtService.isTokenValid(token, userDetails);
        } catch (Exception e) {
            return false;
        }
    }
}
