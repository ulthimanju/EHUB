sequenceDiagram
    participant Client
    participant Controller as AuthController
    participant Service as AuthService
    participant NotifClient as NotificationClient
    participant CommonClient as CommonClient
    participant Repository as UserRepository
    participant DB as PostgreSQL
    participant Security as JwtService

    Note over Client, DB: Registration Flow
    Client->>Controller: POST /auth/register/otp?email=...
    Controller->>Service: requestRegistrationOtp(email)
    Service->>NotifClient: sendOtp(email, REGISTRATION)
    NotifClient->>NotifService: Trigger OTP Send
    NotifService-->>Client: OTP Email sent (10 min expiry)
    
    Client->>Controller: POST /auth/register (Details + OTP)
    Controller->>Service: register(RegisterRequest)
    Service->>NotifClient: validateOtp(email, otp)
    NotifClient-->>Service: boolean
    
    alt is valid
        Service->>CommonClient: getUuid()
        CommonClient-->>Service: New UUID
        Service->>Repository: save(User with role=PARTICIPANT)
        Repository->>DB: Insert
        Service->>Security: generateToken(UserDetails)
        Security-->>Service: JWT Token
        Service-->>Controller: AuthenticationResponse
        Controller-->>Client: 200 OK (Token)
    else is invalid
        Service-->>Controller: Throw InvalidOtpException
        Controller-->>Client: 400 Bad Request
    end

    Note over Client, DB: Role Upgrade Flow
    Client->>Controller: POST /auth/upgrade-role/otp?email=...
    Controller->>Service: requestRoleUpgradeOtp(email)
    Service->>NotifClient: sendOtp(email, ROLE_UPGRADE)
    
    Client->>Controller: POST /auth/upgrade-role (Email + OTP)
    Controller->>Service: upgradeToOrganizer(Email, OTP)
    Service->>NotifClient: validateOtp(email, otp)
    
    alt is valid
        Service->>Repository: findByEmail(email)
        Service->>Repository: user.setRole(ORGANIZER)
        Repository->>DB: Update
        Service-->>Controller: Success
        Controller-->>Client: 200 OK
    else is invalid
        Service-->>Controller: Throw Exception
        Controller-->>Client: 400 Bad Request
    end